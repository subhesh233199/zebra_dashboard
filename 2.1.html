<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>RRR Analysis Tool</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom Styles -->
    <style>
        body {
            background-color: #f4f4f4;
            padding: 30px 15px;
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-bottom: 20px;
            text-align: center;
        }

        #loading {
            display: none;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            color: #555;
        }

        .report-actions button {
            margin-right: 10px;
        }

        #visualizations-content canvas {
            max-width: 100%;
            margin-top: 10px;
        }

        textarea {
            width: 100%;
            height: 400px;
        }

        .section-title {
            margin-top: 40px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>RRR Analysis Tool</h1>

    <div class="row mb-3">
        <div class="col-md-9">
            <input type="text" id="folder-path" class="form-control" placeholder="Enter Folder Path"/>
        </div>
        <div class="col-md-3">
            <button id="analyze-btn" class="btn btn-success w-100">Analyze</button>
        </div>
    </div>

    <div id="loading">
        <p>Loading...</p>
        <p>Analyzing PDFs... This may take a few minutes.</p>
    </div>

    <div id="analysis-report" style="display: none;">
        <h3 class="section-title">Analysis Report</h3>
        <div id="report-content" class="border p-3 rounded"></div>
        <div class="report-actions mt-3">
            <button id="edit-report-btn" class="btn btn-primary">Edit Report</button>
            <button id="save-report-btn" class="btn btn-secondary" style="display: none;">Save Changes</button>
            <button id="cancel-edit-btn" class="btn btn-secondary" style="display: none;">Cancel</button>
            <button id="download-report-btn" class="btn btn-info text-white">Download as PDF</button>
        </div>
    </div>

    <div id="visualizations" style="display: none;">
        <h3 class="section-title">Visualizations</h3>
        <div id="visualizations-content" class="p-3 border rounded"></div>
    </div>

    <div id="evaluation" style="display: none;">
        <h3 class="section-title">Evaluation</h3>
        <div id="evaluation-content" class="p-3 border rounded"></div>
    </div>

    <div id="hyperlinks" style="display: none;">
        <h3 class="section-title">Hyperlinks</h3>
        <div id="hyperlinks-content" class="p-3 border rounded"></div>
    </div>
</div>

<!-- JS Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/marked@14.1.0/lib/marked.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    document.getElementById('analyze-btn').addEventListener('click', async () => {
        let folderPath = document.getElementById('folder-path').value.trim();
        if (!folderPath) {
            alert('Please enter a folder path');
            return;
        }

        folderPath = folderPath.replace(/[\/\\]+/g, '\\').trim();
        if (!/^[a-zA-Z]:[\\\/][a-zA-Z0-9\s._\\\/-]+$/.test(folderPath)) {
            alert('Invalid folder path format. Use a valid Windows path (e.g., C:\\Users\\Name\\Folder).');
            return;
        }

        document.getElementById('loading').style.display = 'block';
        document.getElementById('analysis-report').style.display = 'none';
        document.getElementById('visualizations').style.display = 'none';
        document.getElementById('evaluation').style.display = 'none';
        document.getElementById('hyperlinks').style.display = 'none';

        try {
            const response = await fetch('http://127.0.0.1:8080/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder_path: folderPath })
            });

            if (!response.ok) throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
            const data = await response.json();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('analysis-report').style.display = 'block';
            document.getElementById('visualizations').style.display = 'block';
            document.getElementById('evaluation').style.display = 'block';
            document.getElementById('hyperlinks').style.display = 'block';

            // Report
            let originalContent = data.report || '';
            document.getElementById('report-content').innerHTML = marked.parse(originalContent);

            document.getElementById('edit-report-btn').onclick = () => {
                const textarea = document.createElement('textarea');
                textarea.value = originalContent;
                document.getElementById('report-content').innerHTML = '';
                document.getElementById('report-content').appendChild(textarea);
                document.getElementById('edit-report-btn').style.display = 'none';
                document.getElementById('save-report-btn').style.display = 'inline-block';
                document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            };

            document.getElementById('cancel-edit-btn').onclick = () => {
                document.getElementById('report-content').innerHTML = marked.parse(originalContent);
                document.getElementById('edit-report-btn').style.display = 'inline-block';
                document.getElementById('save-report-btn').style.display = 'none';
                document.getElementById('cancel-edit-btn').style.display = 'none';
            };

            document.getElementById('save-report-btn').onclick = () => {
                const textarea = document.getElementById('report-content').querySelector('textarea');
                originalContent = textarea.value;
                document.getElementById('report-content').innerHTML = marked.parse(originalContent);
                document.getElementById('edit-report-btn').style.display = 'inline-block';
                document.getElementById('save-report-btn').style.display = 'none';
                document.getElementById('cancel-edit-btn').style.display = 'none';
            };

            document.getElementById('download-report-btn').onclick = () => {
                alert('PDF download not implemented in this example');
            };

            // Visualizations
            const vizContainer = document.getElementById('visualizations-content');
            vizContainer.innerHTML = '';
            if (data.visualizations && Array.isArray(data.visualizations)) {
                const canvas = document.createElement('canvas');
                vizContainer.appendChild(canvas);
                new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: data.visualizations.map(v => v.version),
                        datasets: [{
                            label: 'Sample Metric',
                            data: data.visualizations.map(v => v.value),
                            borderColor: '#007bff',
                            fill: false
                        }]
                    },
                    options: { responsive: true }
                });
            }

            // Evaluation
            document.getElementById('evaluation-content').innerHTML = data.evaluation || 'No evaluation provided';

            // Hyperlinks
            const linkList = document.createElement('ul');
            (data.hyperlinks || []).forEach(link => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = link.url;
                a.textContent = link.text;
                a.target = '_blank';
                li.appendChild(a);
                linkList.appendChild(li);
            });
            document.getElementById('hyperlinks-content').innerHTML = '';
            document.getElementById('hyperlinks-content').appendChild(linkList);

        } catch (error) {
            console.error(error);
            alert(`Failed to analyze PDFs: ${error.message}`);
            document.getElementById('loading').style.display = 'none';
        }
    });
</script>
</body>
</html>
